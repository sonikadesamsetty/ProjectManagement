<div>
    <h1 class="border-bottom p-4 bg-info text-white">Project Board</h1>

    <div class="d-flex justify-space-around">
        <input type="text" placeholder="Search..." class="form-control w-50 mt-4" (keyup)="searchProjects($event)" />
        <button class="btn btn-info mt-4 ms-4" (click)="editProject()">Add Project</button>
        <button class="btn btn-info mt-4 ms-4" (click)="createSprint()">
            Create Sprint
        </button>
        <button class="btn btn-info mt-4 ms-4" (click)="manageSprint()">
            Manage Sprint
        </button>
    </div>
    <table class="mt-4 w-75">
        <tr>
            <th style="padding: 10px;  ">Name</th>
            <th style="padding: 10px;  ">Start Date</th>
            <th style="padding: 10px;  ">End Date</th>
            <th style="padding: 10px;  ">Members</th>
            <th style="padding: 10px;  ">Actions</th>
        </tr>
        @for(project of projects; track project.id; let i=$index)
        {
        <tr>
            <td style="padding: 10px;  ">{{project.name}}</td>
            <td style="padding: 10px;  ">{{project.startDate | date:'mediumDate'}}</td>
            <td style="padding: 10px;  ">{{project.endDate | date:'mediumDate'}}</td>
            <td style="padding: 10px;  ">
                <select>
                    @for(member of project.projectMembers; track member.id; let j=$index)
                    {
                    <option [value]="member.id">{{member.name}}</option>
                    }
                </select>
            </td>
            <td style="padding: 10px;  ">
                <button class="btn btn-info" (click)="editProject(project)">Edit</button>
                <button class="btn btn-danger ms-4" (click)="openDeleteModall(project)">Delete</button>
            </td>
        </tr>
        }
    </table>
</div>

<!-- Project Modal -->
<div class="modal" tabindex="-1" style="background: rgba(0,0,0,0.5); display: {{openEditModal ? 'block' : 'none'}};">
    <div class="modal-dialog modal-lg modal-dialog-centered" style="max-width: 50vw; width: 50vw">
        <div class="modal-content">
            <div class="d-flex flex-row align-items-center justify-content-between me-4">
                @if(selectedProject) {
                <h2 class="formItem">Edit Project</h2>
                }@else {
                <h2 class="formItem">Create Project</h2>
                }
                <mat-icon (click)="closeProjectModal()" title="close">close</mat-icon>
            </div>

            <form [formGroup]="projectForm" (ngSubmit)="createOrEditProject()" class="p-4">
                <div class="mb-3 formItem">
                    <label for="projectName" class="form-label">Project Name</label>
                    <input type="text" class="form-control" id="projectName" formControlName="name" required
                        value="{{selectedProject?.name}}" required>
                    @if(projectForm.get('name')?.touched && projectForm.get('name')?.invalid) {
                    <div class="text-danger">
                        Project Name is required.
                    </div>
                    }
                </div>
                <div class="mb-3 formItem">
                    <label for="projectDescription" class="form-label">Description</label>
                    <textarea class="form-control" id="projectDescription" formControlName="description"
                        value="{{selectedProject?.description}}" required></textarea>
                    @if(projectForm.get('description')?.touched && projectForm.get('description')?.invalid) {
                    <div class="text-danger">
                        Description is required.
                    </div>
                    }
                </div>
                <div class="mb-3 formItem">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" formControlName="startDate"
                        value="{{selectedProject?.startDate | date:'yyyy-MM-dd'}}">
                    @if(projectForm.get('startDate')?.touched && projectForm.get('startDate')?.invalid) {
                    <div class="text-danger">
                        Start Date is required.
                    </div>
                    }
                </div>
                <div class="mb-3 formItem">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" formControlName="endDate"
                        value="{{selectedProject?.endDate | date:'yyyy-MM-dd'}}">
                    @if(projectForm.get('endDate')?.touched && projectForm.get('endDate')?.invalid) {
                    <div class="text-danger">
                        End Date is required.
                    </div>
                    }
                </div>
                <div class="mb-3 formItem">
                    <label for="members" class="form-label">Members</label>
                    <!-- when a text entered, call a method-->
                    <div class="d-flex">
                        <!-- update memberErrorMsg when user click on this input-->
                        <input type="text" class="form-control" (click)="memberErrorMsg=''" id="members" #memberInput>
                        <!-- on clicking add icon, call a method to add member to the project -->

                        <mat-icon class="text-primary" (click)="addProjectMember(memberInput.value)"
                            title="Add Member">add</mat-icon>

                    </div>
                    @if(memberErrorMsg)
                    {
                    <div class="text-danger">{{memberErrorMsg}}</div>
                    }
                    <div class="mt-2">
                        @for(user of addedMembers; track user.id; let i=$index)
                        {
                        <div style="display: flex !important; align-items: center;">
                            <span> {{user.name}} </span> <mat-icon class="text-danger"
                                (click)="removeProjectMember(user)" title="remove">close</mat-icon>
                        </div>
                        }
                        @for(user of projectMembers; track user.id; let i=$index)
                        {
                        <div class="d-flex align-items-center">
                            <span> {{user.name}} </span> <mat-icon class="text-danger"
                                (click)="removeProjectMember(user)" title="remove">close</mat-icon>
                        </div>
                        }
                    </div>
                </div>


                <div class="mb-4 me-4 d-flex justify-content-end">
                    <!-- if no validation errors, enable save button-->
                    <button type="submit" class="btn btn-info" [disabled]="projectForm.invalid">Save Changes</button>
                    <button type="button" class="btn btn-secondary ms-4" (click)="closeProjectModal()">Cancel</button>
                </div>

            </form>
        </div>
    </div>
</div>

<!-- Delete Project Modal -->
<div class="modal" tabindex="-1" style="background: rgba(0,0,0,0.5); display: {{openDeleteModal ? 'block' : 'none'}};">
    <div class="modal-dialog modal-lg modal-dialog-centered">
        <div class="modal-content w-50">
            <div class="d-flex flex-row align-items-center justify-content-between me-4">
                <h2 class="formItem">Delete Project</h2>
                <mat-icon (click)="openEditModal = false" title="close">close</mat-icon>
            </div>

            <div class="formItem">
                <p>Are you sure you want to delete this project?</p>
                <div class="mb-4 me-4 d-flex justify-content-end">
                    <button type="submit" class="btn btn-danger" (click)="deleteProject()">Delete</button>
                    <button type="button" class="btn btn-secondary ms-4"
                        (click)="openDeleteModal = false">Cancel</button>
                </div>
            </div>

        </div>
    </div>
</div>

@if(isSprintModalOpen) {
    <app-sprint (closeModal)="closeSprintModal()" [openModal]="true" [isEditMode]="editMode"></app-sprint>
}
<!--Create Sprint Modal-->
<!--<div class="modal" tabindex="-1" style="background: rgba(0,0,0,0.5); display: {{openSprintModal ? 'block' : 'none'}};">
    <div class="modal-dialog modal-lg modal-dialog-centered" style="max-width: 50vw; width: 50vw">
        <div class="modal-content">
            <div class="d-flex flex-row align-items-center justify-content-between me-4">
                <h2 class="formItem">Create Sprint</h2>
                <mat-icon (click)="closeSprintModal()" title="close">close</mat-icon>
            </div>

            <form [formGroup]="sprintForm" (ngSubmit)="onSprintSubmit()" class="p-4">
                <div class="mb-3 formItem">
                    <label for="name" class="form-label">Name</label>
                    <input type="string" class="form-control" id="name" formControlName="name">
                </div>
                @if(sprintForm.get('name')?.touched && sprintForm.get('name')?.invalid) {
                <div class="text-danger ms-3">
                    Sprint Name is required.
                </div>
                }
                <div class="mb-3 formItem">
                    <label for="projectName" class="form-label">Project Name</label>
                    <select formControlName="projectId">
                        @for(project of projects;track project.id;let i=$index) {
                        <option [value]="project.id">{{project.name}}</option>
                        }
                    </select>
                </div>
                @if(sprintForm.get('projectId')?.touched && sprintForm.get('projectId')?.invalid) {
                <div class="text-danger ms-3">
                    Project selection is required.
                </div>
                }

                <div class="mb-3 formItem">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" formControlName="startDate">
                </div>
                @if(sprintForm.get('startDate')?.touched && sprintForm.get('startDate')?.invalid) {
                <div class="text-danger ms-3">
                    Start Date is required.
                </div>
                }
                <div class="mb-3 formItem">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" formControlName="endDate">
                </div>
                @if(sprintForm.get('endDate')?.touched && sprintForm.get('endDate')?.invalid) {
                <div class="text-danger ms-3">
                    End Date is required.
                </div>
                }

                <div class="mb-4 me-4 d-flex justify-content-end">
                    <button type="submit" class="btn btn-info">Save Changes</button>
                    <button type="button" class="btn btn-secondary ms-4" (click)="closeSprintModal()">Cancel</button>
                </div>

            </form>
        </div>
    </div>
</div>-->

<!-- Manage Sprint Modal -->
<!--<div class="modal" tabindex="-1"
    style="background: rgba(0,0,0,0.5); display: {{manageSprintModal ? 'block' : 'none'}};">
    <div class="modal-dialog modal-lg modal-dialog-centered" style="max-width: 50vw; width: 50vw">
        <div class="modal-content">
            <div class="d-flex flex-row align-items-center justify-content-between me-4">
                <h2 class="formItem">Manage Sprints</h2>
                <mat-icon (click)="closeManageSprintModal()" title="close">close</mat-icon>
            </div>

            <form [formGroup]="manageSprintForm" (ngSubmit)="onManageSprintSubmit()" class="p-4">

                <div class="mb-3 formItem">
                    <label for="projectName" class="form-label">Project Name</label>
                    <select formControlName="projectId" (change)="filterSprints()" class="ms-4 w-25">
                        @for(project of projects;track project.id;let i=$index) {
                        <option [value]="project.id">{{project.name}}</option>
                        }
                    </select>
                </div>
                @if(manageSprintForm.get('projectId')?.touched && manageSprintForm.get('projectId')?.invalid) {
                <div class="text-danger ms-3">
                    Project selection is required.
                </div>
                }
                <div class="mb-3 formItem">
                    <label for="name" class="form-label">Name</label>
                    <select formControlName="sprintId" class="ms-4 w-25">
                        @for(sprint of projectSprints;track sprint.id;let i=$index) {
                        <option [value]="sprint.id">{{sprint.name}}</option>
                        }
                    </select>
                </div>
                @if(manageSprintForm.get('sprintId')?.touched && manageSprintForm.get('sprintId')?.invalid) {
                <div class="text-danger ms-3">
                    Sprint selection is required.
                </div>
                }

                <div class="mb-3 formItem">
                    <label for="startDate" class="form-label">Start Date</label>
                    <input type="date" class="form-control" id="startDate" formControlName="startDate">
                </div>
                @if(manageSprintForm.get('startDate')?.touched && manageSprintForm.get('startDate')?.invalid) {
                <div class="text-danger ms-3">
                    Start Date is required.
                </div>
                }
                <div class="mb-3 formItem">
                    <label for="endDate" class="form-label">End Date</label>
                    <input type="date" class="form-control" id="endDate" formControlName="endDate">
                </div>

                @if(manageSprintForm.get('endDate')?.touched && manageSprintForm.get('endDate')?.invalid) {
                <div class="text-danger ms-3">
                    End Date is required.
                </div>
                }
                <div class="mb-4 me-4 d-flex justify-content-end">
                    <button type="submit" class="btn btn-primary">Save Changes</button>
                    <button class="btn btn-danger ms-4" (click)="deleteSprint()">Delete Sprint</button>
                    <button type="button" class="btn btn-secondary ms-4"
                        (click)="closeManageSprintModal()">Cancel</button>
                </div>
            </form>
        </div>
    </div>
</div>-->