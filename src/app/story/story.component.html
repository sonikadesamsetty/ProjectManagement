<form [formGroup]="storyForm" (ngSubmit)="saveChanges()">
    <div class="modal-header">
        <h5 class="modal-title">{{storyId>0?storyId:'Create a new story'}}</h5>
        <button type="button" class="btn-close" aria-label="Close" (click)="close()"></button>
    </div>
    <div class="modal-body" style="overflow-y:auto;">

        <input type="text" value="{{story?.title}}" class="form-control form-control-lg mb-3" placeholder="Story Title"
            aria-label="Story Title" aria-describedby="basic-addon1" formControlName="title">
        <div class="d-flex flex-row w-50 ">
            <div class="me-5">
                <p>Assigned To</p>
                <select style="width: 200px; height: 30px;" formControlName="assignedTo" value="{{story?.assignedTo}}">
                    @for(member of members;track member.id;let k=$index) {
                    <option [value]="member.id">{{member.name}}</option>
                    }
                </select>

                <p class="mt-2">Status</p>
                <select style="width: 200px; height: 30px;" formControlName="status" value="{{story?.status}}">
                    @for(state of states; track state) {
                    <option [value]="state">{{state}}</option>
                    }
                </select>
            </div>
            <div>
                <p>Priority</p>
                <select style="width: 200px; height: 30px;" formControlName="priority" value="{{story?.priority}}">
                    <option value="low">Low</option>
                    <option value="high">High</option>
                    <option value="critical">Critical</option>
                </select>

                <p class="mt-2">Sprint</p>
                <select style="width: 200px; height: 30px;" formControlName="sprintId" value="{{story?.sprintId}}">
                    @for(sprint of filteredSprints;track sprint.id;let k=$index) {
                    <option [value]="sprint.id">{{sprint.name}}</option>
                    }
                </select>
            </div>
        </div>

        <div class="d-flex flex-row mt-3">
            <div class="w-50">
                <p>Description</p>
                <textarea class="form-control" rows="5" formControlName="description"
                    value="{{story?.description}}"></textarea>
            </div>

            <div class="d-flex flex-column w-25 ms-4">
                <div>
                    <p>Capacity</p>
                    <input type="number" class="form-control w-25" formControlName="capacity"
                        value="{{story?.capacity}}" />
                </div>

                <div>
                    <p>DOR</p>
                    <select style="width: 200px; height: 30px;" formControlName="dor" value="{{story?.dor}}">
                        <option value="0">0</option>
                        <option value="1">1</option>
                        <option value="2">2</option>
                        <option value="3">3</option>
                        <option value="4">4</option>
                        <option value="5">5</option>
                    </select>
                </div>
            </div>
            <div class="d-flex flex-column w-25">
                <div>
                    <div>
                        <p>Attachments </p>
                        <div class="d-flex flex-column">
                            <input type="file" #fileInput (change)="onFileSelected($event)">
                            @if(addedFiles.length>0) {
                                @for(file of addedFiles; track file.name; let n=$index) {
                            <div class="d-flex flex-row">
                                <!-- File name should be visible like link with file extension-->
                                 <a class="text-primary text-decoration-underline " (click)="downloadFile(file.name)">
                            {{ file.name }}</a>
                               <mat-icon (click)="deleteFile(file)"
                                style="cursor: pointer;">close</mat-icon>
                            </div>
                        }
                            
                            }

                            @if(attachments.length>0) {
                                @for(file of attachments; track file.fileName; let m=$index) {
                            <div class="d-flex flex-row">
                                <!-- File name should be visible like link with file extension-->
                                 <a class="text-primary text-decoration-underline " (click)="downloadFile(file.fileName)">
                            {{ file.fileName }}</a>
                               <mat-icon (click)="deleteFile(file)"
                                style="cursor: pointer;">close</mat-icon>

                            </div>
                        }
                            
                            }
                        </div>
                    </div>


                </div>

            </div>
            <div class="d-flex flex-column ms-4">
                @if(isNotSubscribed()) {
                <mat-icon title="subscribe" (click)="subscribe()">visibility</mat-icon>
                } @else {
                <!-- off visibility -->
                <mat-icon title="unSubscribe" (click)="unSubscribe()">visibility_off</mat-icon>
                }
                <mat-icon title="Delete" (click)="deleteItem()">delete</mat-icon>
            </div>


        </div>

        <div class="mt-3">
            <p>Acceptance Criteria</p>
            <textarea class="form-control w-50" rows="10" formControlName="acceptanceCriteria"
                value="{{story?.acceptanceCriteria}}"></textarea>
        </div>
        @if(storyId > 0) {
        <div class="mt-3">
            <p>Discussion</p>
            <textarea class="form-control w-50" rows="3" formControlName="discussion" #comments
                value="{{story?.discussion}}"></textarea>
            <!-- Add save and cancel buttons below the text area at right side. it should be below text area not the full right end-->
            <!-- buttons should be visible only if i type something in textarea-->
            @if(comments.value.length > 0) {
            <div class="d-flex justify-content-end mt-2 w-50">
                <button type="button" class="btn btn-secondary me-2">Clear</button>
                <button type="button" class="btn btn-primary">Save</button>
            </div>


            }
        </div>
        }


    </div>
    <div class="modal-footer" style="position: sticky; bottom: 0; background-color: white; right: 0;width: 100%;">
        <button type="button" class="btn btn-secondary" (click)="close()">Close</button>
        <button type="submit" class="btn btn-primary">Save changes</button>
    </div>
</form>